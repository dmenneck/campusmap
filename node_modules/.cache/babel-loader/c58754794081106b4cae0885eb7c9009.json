{"ast":null,"code":"/**\n * @module ol/TileQueue\n */\nimport TileState from './TileState.js';\nimport { listen, unlisten } from './events.js';\nimport EventType from './events/EventType.js';\nimport PriorityQueue from './structs/PriorityQueue.js';\n/**\n * @typedef {function(import(\"./Tile.js\").default, string, import(\"./coordinate.js\").Coordinate, number): number} PriorityFunction\n */\n\nvar TileQueue =\n/*@__PURE__*/\nfunction (PriorityQueue) {\n  function TileQueue(tilePriorityFunction, tileChangeCallback) {\n    PriorityQueue.call(\n    /**\n     * @param {Array} element Element.\n     * @return {number} Priority.\n     */\n    this, function (element) {\n      return tilePriorityFunction.apply(null, element);\n    },\n    /**\n     * @param {Array} element Element.\n     * @return {string} Key.\n     */\n    function (element) {\n      return (\n        /** @type {import(\"./Tile.js\").default} */\n        element[0].getKey()\n      );\n    });\n    /**\n     * @private\n     * @type {function(): ?}\n     */\n\n    this.tileChangeCallback_ = tileChangeCallback;\n    /**\n     * @private\n     * @type {number}\n     */\n\n    this.tilesLoading_ = 0;\n    /**\n     * @private\n     * @type {!Object<string,boolean>}\n     */\n\n    this.tilesLoadingKeys_ = {};\n  }\n\n  if (PriorityQueue) TileQueue.__proto__ = PriorityQueue;\n  TileQueue.prototype = Object.create(PriorityQueue && PriorityQueue.prototype);\n  TileQueue.prototype.constructor = TileQueue;\n  /**\n   * @inheritDoc\n   */\n\n  TileQueue.prototype.enqueue = function enqueue(element) {\n    var added = PriorityQueue.prototype.enqueue.call(this, element);\n\n    if (added) {\n      var tile = element[0];\n      listen(tile, EventType.CHANGE, this.handleTileChange, this);\n    }\n\n    return added;\n  };\n  /**\n   * @return {number} Number of tiles loading.\n   */\n\n\n  TileQueue.prototype.getTilesLoading = function getTilesLoading() {\n    return this.tilesLoading_;\n  };\n  /**\n   * @param {import(\"./events/Event.js\").default} event Event.\n   * @protected\n   */\n\n\n  TileQueue.prototype.handleTileChange = function handleTileChange(event) {\n    var tile =\n    /** @type {import(\"./Tile.js\").default} */\n    event.target;\n    var state = tile.getState();\n\n    if (state === TileState.LOADED || state === TileState.ERROR || state === TileState.EMPTY || state === TileState.ABORT) {\n      unlisten(tile, EventType.CHANGE, this.handleTileChange, this);\n      var tileKey = tile.getKey();\n\n      if (tileKey in this.tilesLoadingKeys_) {\n        delete this.tilesLoadingKeys_[tileKey];\n        --this.tilesLoading_;\n      }\n\n      this.tileChangeCallback_();\n    }\n  };\n  /**\n   * @param {number} maxTotalLoading Maximum number tiles to load simultaneously.\n   * @param {number} maxNewLoads Maximum number of new tiles to load.\n   */\n\n\n  TileQueue.prototype.loadMoreTiles = function loadMoreTiles(maxTotalLoading, maxNewLoads) {\n    var newLoads = 0;\n    var abortedTiles = false;\n    var state, tile, tileKey;\n\n    while (this.tilesLoading_ < maxTotalLoading && newLoads < maxNewLoads && this.getCount() > 0) {\n      tile =\n      /** @type {import(\"./Tile.js\").default} */\n      this.dequeue()[0];\n      tileKey = tile.getKey();\n      state = tile.getState();\n\n      if (state === TileState.ABORT) {\n        abortedTiles = true;\n      } else if (state === TileState.IDLE && !(tileKey in this.tilesLoadingKeys_)) {\n        this.tilesLoadingKeys_[tileKey] = true;\n        ++this.tilesLoading_;\n        ++newLoads;\n        tile.load();\n      }\n    }\n\n    if (newLoads === 0 && abortedTiles) {\n      // Do not stop the render loop when all wanted tiles were aborted due to\n      // a small, saturated tile cache.\n      this.tileChangeCallback_();\n    }\n  };\n\n  return TileQueue;\n}(PriorityQueue);\n\nexport default TileQueue;","map":{"version":3,"sources":["../../src/ol/TileQueue.js"],"names":["super","const","let"],"mappings":"AAAA;;;AAGA,OAAO,SAAP,MAAsB,gBAAtB;AACA,SAAQ,MAAR,EAAgB,QAAhB,QAA+B,aAA/B;AACA,OAAO,SAAP,MAAsB,uBAAtB;AACA,OAAO,aAAP,MAA0B,4BAA1B;;;;;AAQA,IAAM,SAAS;AAAsB;AAAA,UAAA,aAAA,EAAA;AAMnC,WAAA,SAAA,CAAY,oBAAZ,EAAkC,kBAAlC,EAAsD;AAEpDA,IAAAA,aAAAA,CAAAA,IAAAA;;;;;QAAAA,EAKE,UAAS,OAAT,EAAkB;AAChB,aAAO,oBAAoB,CAAC,KAArB,CAA2B,IAA3B,EAAiC,OAAjC,CAAP;AACD,KAPHA;;;;;AAYE,cAAS,OAAT,EAAkB;AAChB;AAAO;AAA6C,QAAA,OAAO,CAAC,CAAD,CAAR,CAAa,MAAb;AAAnD;AACD,KAdHA;;;;;;AAoBA,SAAK,mBAAL,GAA2B,kBAA3B;;;;;;AAMA,SAAK,aAAL,GAAqB,CAArB;;;;;;AAMA,SAAK,iBAAL,GAAyB,EAAzB;;;;;oCAED,S;;;;;sBAKD,O,GAAA,SAAA,OAAA,CAAQ,OAAR,EAAiB;AACfC,QAAM,KAAK,GAAGD,aAAAA,CAAAA,SAAAA,CAAM,OAANA,CAAM,IAANA,CAAa,IAAbA,EAAc,OAAdA,CAAdC;;AACA,QAAI,KAAJ,EAAW;AACTA,UAAM,IAAI,GAAG,OAAO,CAAC,CAAD,CAApBA;AACA,MAAA,MAAM,CAAC,IAAD,EAAO,SAAS,CAAC,MAAjB,EAAyB,KAAK,gBAA9B,EAAgD,IAAhD,CAAN;AACD;;AACD,WAAO,KAAP;AACD,G;;;;;;sBAKD,e,GAAA,SAAA,eAAA,GAAkB;AAChB,WAAO,KAAK,aAAZ;AACD,G;;;;;;;sBAMD,gB,GAAA,SAAA,gBAAA,CAAiB,KAAjB,EAAwB;AACtBA,QAAM,IAAI;AAAA;AAA+C,IAAA,KAAK,CAAC,MAA/DA;AACAA,QAAM,KAAK,GAAG,IAAI,CAAC,QAAL,EAAdA;;AACA,QAAI,KAAK,KAAK,SAAS,CAAC,MAApB,IAA8B,KAAK,KAAK,SAAS,CAAC,KAAlD,IACA,KAAK,KAAK,SAAS,CAAC,KADpB,IAC6B,KAAK,KAAK,SAAS,CAAC,KADrD,EAC4D;AAC1D,MAAA,QAAQ,CAAC,IAAD,EAAO,SAAS,CAAC,MAAjB,EAAyB,KAAK,gBAA9B,EAAgD,IAAhD,CAAR;AACAA,UAAM,OAAO,GAAG,IAAI,CAAC,MAAL,EAAhBA;;AACA,UAAI,OAAO,IAAI,KAAK,iBAApB,EAAuC;AACrC,eAAO,KAAK,iBAAL,CAAuB,OAAvB,CAAP;AACA,UAAE,KAAK,aAAP;AACD;;AACD,WAAK,mBAAL;AACD;AACF,G;;;;;;;sBAMD,a,GAAA,SAAA,aAAA,CAAc,eAAd,EAA+B,WAA/B,EAA4C;AAC1CC,QAAI,QAAQ,GAAG,CAAfA;AACAA,QAAI,YAAY,GAAG,KAAnBA;AACAA,QAAI,KAAJA,EAAW,IAAXA,EAAiB,OAAjBA;;AACA,WAAO,KAAK,aAAL,GAAqB,eAArB,IAAwC,QAAQ,GAAG,WAAnD,IACA,KAAK,QAAL,KAAkB,CADzB,EAC4B;AAC1B,MAAA,IAAI;AAAA;AAA+C,WAAK,OAAL,GAAe,CAAf,CAAnD;AACA,MAAA,OAAO,GAAG,IAAI,CAAC,MAAL,EAAV;AACA,MAAA,KAAK,GAAG,IAAI,CAAC,QAAL,EAAR;;AACA,UAAI,KAAK,KAAK,SAAS,CAAC,KAAxB,EAA+B;AAC7B,QAAA,YAAY,GAAG,IAAf;AACD,OAFD,MAEO,IAAI,KAAK,KAAK,SAAS,CAAC,IAApB,IAA4B,EAAE,OAAO,IAAI,KAAK,iBAAlB,CAAhC,EAAsE;AAC3E,aAAK,iBAAL,CAAuB,OAAvB,IAAkC,IAAlC;AACA,UAAE,KAAK,aAAP;AACA,UAAE,QAAF;AACA,QAAA,IAAI,CAAC,IAAL;AACD;AACF;;AACD,QAAI,QAAQ,KAAK,CAAb,IAAkB,YAAtB,EAAoC;;;AAGlC,WAAK,mBAAL;AACD;AACF,G;;;CA7GkC,CAAb,aAAa,CAArC;;AAiHA,eAAe,SAAf","sourcesContent":["/**\n * @module ol/TileQueue\n */\nimport TileState from './TileState.js';\nimport {listen, unlisten} from './events.js';\nimport EventType from './events/EventType.js';\nimport PriorityQueue from './structs/PriorityQueue.js';\n\n\n/**\n * @typedef {function(import(\"./Tile.js\").default, string, import(\"./coordinate.js\").Coordinate, number): number} PriorityFunction\n */\n\n\nclass TileQueue extends PriorityQueue {\n\n  /**\n   * @param {PriorityFunction} tilePriorityFunction Tile priority function.\n   * @param {function(): ?} tileChangeCallback Function called on each tile change event.\n   */\n  constructor(tilePriorityFunction, tileChangeCallback) {\n\n    super(\n      /**\n       * @param {Array} element Element.\n       * @return {number} Priority.\n       */\n      function(element) {\n        return tilePriorityFunction.apply(null, element);\n      },\n      /**\n       * @param {Array} element Element.\n       * @return {string} Key.\n       */\n      function(element) {\n        return (/** @type {import(\"./Tile.js\").default} */ (element[0]).getKey());\n      });\n\n    /**\n     * @private\n     * @type {function(): ?}\n     */\n    this.tileChangeCallback_ = tileChangeCallback;\n\n    /**\n     * @private\n     * @type {number}\n     */\n    this.tilesLoading_ = 0;\n\n    /**\n     * @private\n     * @type {!Object<string,boolean>}\n     */\n    this.tilesLoadingKeys_ = {};\n\n  }\n\n  /**\n   * @inheritDoc\n   */\n  enqueue(element) {\n    const added = super.enqueue(element);\n    if (added) {\n      const tile = element[0];\n      listen(tile, EventType.CHANGE, this.handleTileChange, this);\n    }\n    return added;\n  }\n\n  /**\n   * @return {number} Number of tiles loading.\n   */\n  getTilesLoading() {\n    return this.tilesLoading_;\n  }\n\n  /**\n   * @param {import(\"./events/Event.js\").default} event Event.\n   * @protected\n   */\n  handleTileChange(event) {\n    const tile = /** @type {import(\"./Tile.js\").default} */ (event.target);\n    const state = tile.getState();\n    if (state === TileState.LOADED || state === TileState.ERROR ||\n        state === TileState.EMPTY || state === TileState.ABORT) {\n      unlisten(tile, EventType.CHANGE, this.handleTileChange, this);\n      const tileKey = tile.getKey();\n      if (tileKey in this.tilesLoadingKeys_) {\n        delete this.tilesLoadingKeys_[tileKey];\n        --this.tilesLoading_;\n      }\n      this.tileChangeCallback_();\n    }\n  }\n\n  /**\n   * @param {number} maxTotalLoading Maximum number tiles to load simultaneously.\n   * @param {number} maxNewLoads Maximum number of new tiles to load.\n   */\n  loadMoreTiles(maxTotalLoading, maxNewLoads) {\n    let newLoads = 0;\n    let abortedTiles = false;\n    let state, tile, tileKey;\n    while (this.tilesLoading_ < maxTotalLoading && newLoads < maxNewLoads &&\n           this.getCount() > 0) {\n      tile = /** @type {import(\"./Tile.js\").default} */ (this.dequeue()[0]);\n      tileKey = tile.getKey();\n      state = tile.getState();\n      if (state === TileState.ABORT) {\n        abortedTiles = true;\n      } else if (state === TileState.IDLE && !(tileKey in this.tilesLoadingKeys_)) {\n        this.tilesLoadingKeys_[tileKey] = true;\n        ++this.tilesLoading_;\n        ++newLoads;\n        tile.load();\n      }\n    }\n    if (newLoads === 0 && abortedTiles) {\n      // Do not stop the render loop when all wanted tiles were aborted due to\n      // a small, saturated tile cache.\n      this.tileChangeCallback_();\n    }\n  }\n}\n\n\nexport default TileQueue;\n"]},"metadata":{},"sourceType":"module"}