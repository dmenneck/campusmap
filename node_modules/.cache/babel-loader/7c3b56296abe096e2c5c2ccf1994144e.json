{"ast":null,"code":"/**\n * @module ol/renderer/Map\n */\nimport { abstract, getUid } from '../util.js';\nimport Disposable from '../Disposable.js';\nimport { listen, unlistenByKey } from '../events.js';\nimport EventType from '../events/EventType.js';\nimport { getWidth } from '../extent.js';\nimport { TRUE } from '../functions.js';\nimport { visibleAtResolution } from '../layer/Layer.js';\nimport { shared as iconImageCache } from '../style/IconImageCache.js';\nimport { compose as composeTransform, invert as invertTransform, setFromArray as transformSetFromArray } from '../transform.js';\n/**\n * @abstract\n */\n\nvar MapRenderer =\n/*@__PURE__*/\nfunction (Disposable) {\n  function MapRenderer(map) {\n    Disposable.call(this);\n    /**\n     * @private\n     * @type {import(\"../PluggableMap.js\").default}\n     */\n\n    this.map_ = map;\n    /**\n     * @private\n     * @type {!Object<string, import(\"./Layer.js\").default>}\n     */\n\n    this.layerRenderers_ = {};\n    /**\n     * @private\n     * @type {Object<string, import(\"../events.js\").EventsKey>}\n     */\n\n    this.layerRendererListeners_ = {};\n    /**\n     * @private\n     * @type {Array<typeof import(\"./Layer.js\").default>}\n     */\n\n    this.layerRendererConstructors_ = [];\n  }\n\n  if (Disposable) MapRenderer.__proto__ = Disposable;\n  MapRenderer.prototype = Object.create(Disposable && Disposable.prototype);\n  MapRenderer.prototype.constructor = MapRenderer;\n  /**\n   * @abstract\n   * @param {import(\"../render/EventType.js\").default} type Event type.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n\n  MapRenderer.prototype.dispatchRenderEvent = function dispatchRenderEvent(type, frameState) {\n    abstract();\n  };\n  /**\n   * Register layer renderer constructors.\n   * @param {Array<typeof import(\"./Layer.js\").default>} constructors Layer renderers.\n   */\n\n\n  MapRenderer.prototype.registerLayerRenderers = function registerLayerRenderers(constructors) {\n    this.layerRendererConstructors_.push.apply(this.layerRendererConstructors_, constructors);\n  };\n  /**\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @protected\n   */\n\n\n  MapRenderer.prototype.calculateMatrices2D = function calculateMatrices2D(frameState) {\n    var viewState = frameState.viewState;\n    var coordinateToPixelTransform = frameState.coordinateToPixelTransform;\n    var pixelToCoordinateTransform = frameState.pixelToCoordinateTransform;\n    composeTransform(coordinateToPixelTransform, frameState.size[0] / 2, frameState.size[1] / 2, 1 / viewState.resolution, -1 / viewState.resolution, -viewState.rotation, -viewState.center[0], -viewState.center[1]);\n    invertTransform(transformSetFromArray(pixelToCoordinateTransform, coordinateToPixelTransform));\n  };\n  /**\n   * Removes all layer renderers.\n   */\n\n\n  MapRenderer.prototype.removeLayerRenderers = function removeLayerRenderers() {\n    for (var key in this.layerRenderers_) {\n      this.removeLayerRendererByKey_(key).dispose();\n    }\n  };\n  /**\n   * @param {import(\"../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(this: S, import(\"../Feature.js\").FeatureLike,\n   *     import(\"../layer/Layer.js\").default): T} callback Feature callback.\n   * @param {S} thisArg Value to use as `this` when executing `callback`.\n   * @param {function(this: U, import(\"../layer/Layer.js\").default): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @param {U} thisArg2 Value to use as `this` when executing `layerFilter`.\n   * @return {T|undefined} Callback result.\n   * @template S,T,U\n   */\n\n\n  MapRenderer.prototype.forEachFeatureAtCoordinate = function forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, callback, thisArg, layerFilter, thisArg2) {\n    var result;\n    var viewState = frameState.viewState;\n    var viewResolution = viewState.resolution;\n    /**\n     * @param {import(\"../Feature.js\").FeatureLike} feature Feature.\n     * @param {import(\"../layer/Layer.js\").default} layer Layer.\n     * @return {?} Callback result.\n     */\n\n    function forEachFeatureAtCoordinate(feature, layer) {\n      var managed = frameState.layerStates[getUid(layer)].managed;\n\n      if (!(getUid(feature) in frameState.skippedFeatureUids && !managed)) {\n        return callback.call(thisArg, feature, managed ? layer : null);\n      }\n    }\n\n    var projection = viewState.projection;\n    var translatedCoordinate = coordinate;\n\n    if (projection.canWrapX()) {\n      var projectionExtent = projection.getExtent();\n      var worldWidth = getWidth(projectionExtent);\n      var x = coordinate[0];\n\n      if (x < projectionExtent[0] || x > projectionExtent[2]) {\n        var worldsAway = Math.ceil((projectionExtent[0] - x) / worldWidth);\n        translatedCoordinate = [x + worldWidth * worldsAway, coordinate[1]];\n      }\n    }\n\n    var layerStates = frameState.layerStatesArray;\n    var numLayers = layerStates.length;\n    var i;\n\n    for (i = numLayers - 1; i >= 0; --i) {\n      var layerState = layerStates[i];\n      var layer = layerState.layer;\n\n      if (visibleAtResolution(layerState, viewResolution) && layerFilter.call(thisArg2, layer)) {\n        var layerRenderer = this.getLayerRenderer(layer);\n        var source =\n        /** @type {import(\"../layer/Layer.js\").default} */\n        layer.getSource();\n\n        if (source) {\n          result = layerRenderer.forEachFeatureAtCoordinate(source.getWrapX() ? translatedCoordinate : coordinate, frameState, hitTolerance, forEachFeatureAtCoordinate);\n        }\n\n        if (result) {\n          return result;\n        }\n      }\n    }\n\n    return undefined;\n  };\n  /**\n   * @abstract\n   * @param {import(\"../pixel.js\").Pixel} pixel Pixel.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(this: S, import(\"../layer/Layer.js\").default, (Uint8ClampedArray|Uint8Array)): T} callback Layer\n   *     callback.\n   * @param {S} thisArg Value to use as `this` when executing `callback`.\n   * @param {function(this: U, import(\"../layer/Layer.js\").default): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @param {U} thisArg2 Value to use as `this` when executing `layerFilter`.\n   * @return {T|undefined} Callback result.\n   * @template S,T,U\n   */\n\n\n  MapRenderer.prototype.forEachLayerAtPixel = function forEachLayerAtPixel(pixel, frameState, hitTolerance, callback, thisArg, layerFilter, thisArg2) {\n    return abstract();\n  };\n  /**\n   * @param {import(\"../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(this: U, import(\"../layer/Layer.js\").default): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @param {U} thisArg Value to use as `this` when executing `layerFilter`.\n   * @return {boolean} Is there a feature at the given coordinate?\n   * @template U\n   */\n\n\n  MapRenderer.prototype.hasFeatureAtCoordinate = function hasFeatureAtCoordinate(coordinate, frameState, hitTolerance, layerFilter, thisArg) {\n    var hasFeature = this.forEachFeatureAtCoordinate(coordinate, frameState, hitTolerance, TRUE, this, layerFilter, thisArg);\n    return hasFeature !== undefined;\n  };\n  /**\n   * @param {import(\"../layer/Base.js\").default} layer Layer.\n   * @protected\n   * @return {import(\"./Layer.js\").default} Layer renderer.\n   */\n\n\n  MapRenderer.prototype.getLayerRenderer = function getLayerRenderer(layer) {\n    var layerKey = getUid(layer);\n\n    if (layerKey in this.layerRenderers_) {\n      return this.layerRenderers_[layerKey];\n    } else {\n      var renderer;\n\n      for (var i = 0, ii = this.layerRendererConstructors_.length; i < ii; ++i) {\n        var candidate = this.layerRendererConstructors_[i];\n\n        if (candidate['handles'](layer)) {\n          renderer = candidate['create'](this, layer);\n          break;\n        }\n      }\n\n      if (renderer) {\n        this.layerRenderers_[layerKey] = renderer;\n        this.layerRendererListeners_[layerKey] = listen(renderer, EventType.CHANGE, this.handleLayerRendererChange_, this);\n      } else {\n        throw new Error('Unable to create renderer for layer: ' + layer.getType());\n      }\n\n      return renderer;\n    }\n  };\n  /**\n   * @param {string} layerKey Layer key.\n   * @protected\n   * @return {import(\"./Layer.js\").default} Layer renderer.\n   */\n\n\n  MapRenderer.prototype.getLayerRendererByKey = function getLayerRendererByKey(layerKey) {\n    return this.layerRenderers_[layerKey];\n  };\n  /**\n   * @protected\n   * @return {Object<string, import(\"./Layer.js\").default>} Layer renderers.\n   */\n\n\n  MapRenderer.prototype.getLayerRenderers = function getLayerRenderers() {\n    return this.layerRenderers_;\n  };\n  /**\n   * @return {import(\"../PluggableMap.js\").default} Map.\n   */\n\n\n  MapRenderer.prototype.getMap = function getMap() {\n    return this.map_;\n  };\n  /**\n   * Handle changes in a layer renderer.\n   * @private\n   */\n\n\n  MapRenderer.prototype.handleLayerRendererChange_ = function handleLayerRendererChange_() {\n    this.map_.render();\n  };\n  /**\n   * @param {string} layerKey Layer key.\n   * @return {import(\"./Layer.js\").default} Layer renderer.\n   * @private\n   */\n\n\n  MapRenderer.prototype.removeLayerRendererByKey_ = function removeLayerRendererByKey_(layerKey) {\n    var layerRenderer = this.layerRenderers_[layerKey];\n    delete this.layerRenderers_[layerKey];\n    unlistenByKey(this.layerRendererListeners_[layerKey]);\n    delete this.layerRendererListeners_[layerKey];\n    return layerRenderer;\n  };\n  /**\n   * @param {import(\"../PluggableMap.js\").default} map Map.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   * @private\n   */\n\n\n  MapRenderer.prototype.removeUnusedLayerRenderers_ = function removeUnusedLayerRenderers_(map, frameState) {\n    for (var layerKey in this.layerRenderers_) {\n      if (!frameState || !(layerKey in frameState.layerStates)) {\n        this.removeLayerRendererByKey_(layerKey).dispose();\n      }\n    }\n  };\n  /**\n   * Render.\n   * @abstract\n   * @param {?import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n\n\n  MapRenderer.prototype.renderFrame = function renderFrame(frameState) {\n    abstract();\n  };\n  /**\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   * @protected\n   */\n\n\n  MapRenderer.prototype.scheduleExpireIconCache = function scheduleExpireIconCache(frameState) {\n    frameState.postRenderFunctions.push(\n    /** @type {import(\"../PluggableMap.js\").PostRenderFunction} */\n    expireIconCache);\n  };\n  /**\n   * @param {!import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   * @protected\n   */\n\n\n  MapRenderer.prototype.scheduleRemoveUnusedLayerRenderers = function scheduleRemoveUnusedLayerRenderers(frameState) {\n    for (var layerKey in this.layerRenderers_) {\n      if (!(layerKey in frameState.layerStates)) {\n        frameState.postRenderFunctions.push(\n        /** @type {import(\"../PluggableMap.js\").PostRenderFunction} */\n        this.removeUnusedLayerRenderers_.bind(this));\n        return;\n      }\n    }\n  };\n\n  return MapRenderer;\n}(Disposable);\n/**\n * @param {import(\"../PluggableMap.js\").default} map Map.\n * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n */\n\n\nfunction expireIconCache(map, frameState) {\n  iconImageCache.expire();\n}\n/**\n * @param {import(\"../layer/Layer.js\").State} state1 First layer state.\n * @param {import(\"../layer/Layer.js\").State} state2 Second layer state.\n * @return {number} The zIndex difference.\n */\n\n\nexport function sortByZIndex(state1, state2) {\n  return state1.zIndex - state2.zIndex;\n}\nexport default MapRenderer;","map":{"version":3,"sources":["../../../src/ol/renderer/Map.js"],"names":["super","const","let"],"mappings":"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","sourcesContent":["/**\n * @module ol/renderer/Map\n */\nimport {abstract, getUid} from '../util.js';\nimport Disposable from '../Disposable.js';\nimport {listen, unlistenByKey} from '../events.js';\nimport EventType from '../events/EventType.js';\nimport {getWidth} from '../extent.js';\nimport {TRUE} from '../functions.js';\nimport {visibleAtResolution} from '../layer/Layer.js';\nimport {shared as iconImageCache} from '../style/IconImageCache.js';\nimport {compose as composeTransform, invert as invertTransform, setFromArray as transformSetFromArray} from '../transform.js';\n\n/**\n * @abstract\n */\nclass MapRenderer extends Disposable {\n\n  /**\n   * @param {import(\"../PluggableMap.js\").default} map Map.\n   */\n  constructor(map) {\n    super();\n\n    /**\n     * @private\n     * @type {import(\"../PluggableMap.js\").default}\n     */\n    this.map_ = map;\n\n    /**\n     * @private\n     * @type {!Object<string, import(\"./Layer.js\").default>}\n     */\n    this.layerRenderers_ = {};\n\n    /**\n     * @private\n     * @type {Object<string, import(\"../events.js\").EventsKey>}\n     */\n    this.layerRendererListeners_ = {};\n\n    /**\n     * @private\n     * @type {Array<typeof import(\"./Layer.js\").default>}\n     */\n    this.layerRendererConstructors_ = [];\n\n  }\n\n  /**\n   * @abstract\n   * @param {import(\"../render/EventType.js\").default} type Event type.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n  dispatchRenderEvent(type, frameState) {\n    abstract();\n  }\n\n  /**\n   * Register layer renderer constructors.\n   * @param {Array<typeof import(\"./Layer.js\").default>} constructors Layer renderers.\n   */\n  registerLayerRenderers(constructors) {\n    this.layerRendererConstructors_.push.apply(this.layerRendererConstructors_, constructors);\n  }\n\n  /**\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @protected\n   */\n  calculateMatrices2D(frameState) {\n    const viewState = frameState.viewState;\n    const coordinateToPixelTransform = frameState.coordinateToPixelTransform;\n    const pixelToCoordinateTransform = frameState.pixelToCoordinateTransform;\n\n    composeTransform(coordinateToPixelTransform,\n      frameState.size[0] / 2, frameState.size[1] / 2,\n      1 / viewState.resolution, -1 / viewState.resolution,\n      -viewState.rotation,\n      -viewState.center[0], -viewState.center[1]);\n\n    invertTransform(\n      transformSetFromArray(pixelToCoordinateTransform, coordinateToPixelTransform));\n  }\n\n  /**\n   * Removes all layer renderers.\n   */\n  removeLayerRenderers() {\n    for (const key in this.layerRenderers_) {\n      this.removeLayerRendererByKey_(key).dispose();\n    }\n  }\n\n  /**\n   * @param {import(\"../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(this: S, import(\"../Feature.js\").FeatureLike,\n   *     import(\"../layer/Layer.js\").default): T} callback Feature callback.\n   * @param {S} thisArg Value to use as `this` when executing `callback`.\n   * @param {function(this: U, import(\"../layer/Layer.js\").default): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @param {U} thisArg2 Value to use as `this` when executing `layerFilter`.\n   * @return {T|undefined} Callback result.\n   * @template S,T,U\n   */\n  forEachFeatureAtCoordinate(\n    coordinate,\n    frameState,\n    hitTolerance,\n    callback,\n    thisArg,\n    layerFilter,\n    thisArg2\n  ) {\n    let result;\n    const viewState = frameState.viewState;\n    const viewResolution = viewState.resolution;\n\n    /**\n     * @param {import(\"../Feature.js\").FeatureLike} feature Feature.\n     * @param {import(\"../layer/Layer.js\").default} layer Layer.\n     * @return {?} Callback result.\n     */\n    function forEachFeatureAtCoordinate(feature, layer) {\n      const managed = frameState.layerStates[getUid(layer)].managed;\n      if (!(getUid(feature) in frameState.skippedFeatureUids && !managed)) {\n        return callback.call(thisArg, feature, managed ? layer : null);\n      }\n    }\n\n    const projection = viewState.projection;\n\n    let translatedCoordinate = coordinate;\n    if (projection.canWrapX()) {\n      const projectionExtent = projection.getExtent();\n      const worldWidth = getWidth(projectionExtent);\n      const x = coordinate[0];\n      if (x < projectionExtent[0] || x > projectionExtent[2]) {\n        const worldsAway = Math.ceil((projectionExtent[0] - x) / worldWidth);\n        translatedCoordinate = [x + worldWidth * worldsAway, coordinate[1]];\n      }\n    }\n\n    const layerStates = frameState.layerStatesArray;\n    const numLayers = layerStates.length;\n    let i;\n    for (i = numLayers - 1; i >= 0; --i) {\n      const layerState = layerStates[i];\n      const layer = layerState.layer;\n      if (visibleAtResolution(layerState, viewResolution) && layerFilter.call(thisArg2, layer)) {\n        const layerRenderer = this.getLayerRenderer(layer);\n        const source = /** @type {import(\"../layer/Layer.js\").default} */ (layer).getSource();\n        if (source) {\n          result = layerRenderer.forEachFeatureAtCoordinate(\n            source.getWrapX() ? translatedCoordinate : coordinate,\n            frameState, hitTolerance, forEachFeatureAtCoordinate);\n        }\n        if (result) {\n          return result;\n        }\n      }\n    }\n    return undefined;\n  }\n\n  /**\n   * @abstract\n   * @param {import(\"../pixel.js\").Pixel} pixel Pixel.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(this: S, import(\"../layer/Layer.js\").default, (Uint8ClampedArray|Uint8Array)): T} callback Layer\n   *     callback.\n   * @param {S} thisArg Value to use as `this` when executing `callback`.\n   * @param {function(this: U, import(\"../layer/Layer.js\").default): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @param {U} thisArg2 Value to use as `this` when executing `layerFilter`.\n   * @return {T|undefined} Callback result.\n   * @template S,T,U\n   */\n  forEachLayerAtPixel(pixel, frameState, hitTolerance, callback, thisArg, layerFilter, thisArg2) {\n    return abstract();\n  }\n\n  /**\n   * @param {import(\"../coordinate.js\").Coordinate} coordinate Coordinate.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState FrameState.\n   * @param {number} hitTolerance Hit tolerance in pixels.\n   * @param {function(this: U, import(\"../layer/Layer.js\").default): boolean} layerFilter Layer filter\n   *     function, only layers which are visible and for which this function\n   *     returns `true` will be tested for features.  By default, all visible\n   *     layers will be tested.\n   * @param {U} thisArg Value to use as `this` when executing `layerFilter`.\n   * @return {boolean} Is there a feature at the given coordinate?\n   * @template U\n   */\n  hasFeatureAtCoordinate(coordinate, frameState, hitTolerance, layerFilter, thisArg) {\n    const hasFeature = this.forEachFeatureAtCoordinate(\n      coordinate, frameState, hitTolerance, TRUE, this, layerFilter, thisArg);\n\n    return hasFeature !== undefined;\n  }\n\n  /**\n   * @param {import(\"../layer/Base.js\").default} layer Layer.\n   * @protected\n   * @return {import(\"./Layer.js\").default} Layer renderer.\n   */\n  getLayerRenderer(layer) {\n    const layerKey = getUid(layer);\n    if (layerKey in this.layerRenderers_) {\n      return this.layerRenderers_[layerKey];\n    } else {\n      let renderer;\n      for (let i = 0, ii = this.layerRendererConstructors_.length; i < ii; ++i) {\n        const candidate = this.layerRendererConstructors_[i];\n        if (candidate['handles'](layer)) {\n          renderer = candidate['create'](this, layer);\n          break;\n        }\n      }\n      if (renderer) {\n        this.layerRenderers_[layerKey] = renderer;\n        this.layerRendererListeners_[layerKey] = listen(renderer,\n          EventType.CHANGE, this.handleLayerRendererChange_, this);\n      } else {\n        throw new Error('Unable to create renderer for layer: ' + layer.getType());\n      }\n      return renderer;\n    }\n  }\n\n  /**\n   * @param {string} layerKey Layer key.\n   * @protected\n   * @return {import(\"./Layer.js\").default} Layer renderer.\n   */\n  getLayerRendererByKey(layerKey) {\n    return this.layerRenderers_[layerKey];\n  }\n\n  /**\n   * @protected\n   * @return {Object<string, import(\"./Layer.js\").default>} Layer renderers.\n   */\n  getLayerRenderers() {\n    return this.layerRenderers_;\n  }\n\n  /**\n   * @return {import(\"../PluggableMap.js\").default} Map.\n   */\n  getMap() {\n    return this.map_;\n  }\n\n  /**\n   * Handle changes in a layer renderer.\n   * @private\n   */\n  handleLayerRendererChange_() {\n    this.map_.render();\n  }\n\n  /**\n   * @param {string} layerKey Layer key.\n   * @return {import(\"./Layer.js\").default} Layer renderer.\n   * @private\n   */\n  removeLayerRendererByKey_(layerKey) {\n    const layerRenderer = this.layerRenderers_[layerKey];\n    delete this.layerRenderers_[layerKey];\n\n    unlistenByKey(this.layerRendererListeners_[layerKey]);\n    delete this.layerRendererListeners_[layerKey];\n\n    return layerRenderer;\n  }\n\n  /**\n   * @param {import(\"../PluggableMap.js\").default} map Map.\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   * @private\n   */\n  removeUnusedLayerRenderers_(map, frameState) {\n    for (const layerKey in this.layerRenderers_) {\n      if (!frameState || !(layerKey in frameState.layerStates)) {\n        this.removeLayerRendererByKey_(layerKey).dispose();\n      }\n    }\n  }\n\n  /**\n   * Render.\n   * @abstract\n   * @param {?import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   */\n  renderFrame(frameState) {\n    abstract();\n  }\n\n  /**\n   * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   * @protected\n   */\n  scheduleExpireIconCache(frameState) {\n    frameState.postRenderFunctions.push(/** @type {import(\"../PluggableMap.js\").PostRenderFunction} */ (expireIconCache));\n  }\n\n  /**\n   * @param {!import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n   * @protected\n   */\n  scheduleRemoveUnusedLayerRenderers(frameState) {\n    for (const layerKey in this.layerRenderers_) {\n      if (!(layerKey in frameState.layerStates)) {\n        frameState.postRenderFunctions.push(\n          /** @type {import(\"../PluggableMap.js\").PostRenderFunction} */ (this.removeUnusedLayerRenderers_.bind(this))\n        );\n        return;\n      }\n    }\n  }\n}\n\n\n/**\n * @param {import(\"../PluggableMap.js\").default} map Map.\n * @param {import(\"../PluggableMap.js\").FrameState} frameState Frame state.\n */\nfunction expireIconCache(map, frameState) {\n  iconImageCache.expire();\n}\n\n\n/**\n * @param {import(\"../layer/Layer.js\").State} state1 First layer state.\n * @param {import(\"../layer/Layer.js\").State} state2 Second layer state.\n * @return {number} The zIndex difference.\n */\nexport function sortByZIndex(state1, state2) {\n  return state1.zIndex - state2.zIndex;\n}\nexport default MapRenderer;\n"]},"metadata":{},"sourceType":"module"}